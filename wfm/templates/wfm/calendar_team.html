{% extends 'site/base.html' %}

{% block title %}Team Schedule{% endblock %}

    {% block head_css_section %}
        {% load static %}
        <link href="{% static "shifts/fullcalendar.min.css" %}" rel='stylesheet' />
        <link href="{% static "shifts/scheduler.min.css" %}" rel='stylesheet' />
        <link href="{% static "shifts/fullcalendar.print.min.css" %}" rel='stylesheet' media="print" />
    {% endblock head_css_section %}

    {% block head_css_page %}
        <style>

        body {

            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }

    </style>
    {% endblock head_css_page %}

{% block head_js %}
    {% load static %}
    <script src="{% static "shifts/lib/moment.min.js" %}"></script>
    <script src="{% static "shifts/fullcalendar.min.js" %}"></script>
    <script src="{% static "shifts/scheduler.min.js" %}"></script>

    <script>

	   $(document).ready(function() {

		$('#calendar').fullCalendar({
            height: 700,
            contentHeight: 700,
            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
            resourcesInitiallyExpanded: false,
            header: {
				left: 'prev,next today',
				center: 'title',
                right: 'timelineMonth,timelineWeek,timelineDay'
			},
            defaultView: 'timelineDay',
			//defaultDate: '2017-09-12',
			editable: true,
			eventLimit: true, // allow "more" link when too many events
            resourceOrder: 'title,',
            views: {
                timelineDay: {
                    buttonText: "Day",
                    snapDuration: '00:05:00',
                    displayEventTime: true,
                    displayEventEnd: true,
                    nowIndicator: true,
                },
                timelineWeek: {
                    buttonText: "Week",
                    snapDuration: '00:05:00',
                    displayEventTime: true,
                    displayEventEnd: true,
                },
                timelineMonth: {
                    buttonText: "Month",
                    snapDuration: '00:05:00',
                    displayEventTime: true,
                    displayEventEnd: true,
                },
            },
            resources: {
                url: '/wfm/resources/',
                type: 'GET'
              },
            events:
                // your event source
                {
                    url: '/wfm/team_events/', // use the `url` property
                },
            eventDrop: function(event, delta, revertFunc) {

                if (!confirm("Are you sure about this change?")) {
                    revertFunc();
                }
                else{

                    var theUrl = "/wfm/change/";
                    var json_upload = JSON.stringify({profile:event.resourceId, event:event.id, start: event.start, end: event.end, title: event.title, time_delta: delta.asMinutes()});

                    var xmlHttp = new XMLHttpRequest();

                    xmlHttp.onreadystatechange = function() {
                        if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                            var stat = JSON.parse(xmlHttp.responseText);
                            if(stat.Status == 'OK'){
                                Materialize.toast(stat.data, 4000);
                                $('#calendar').fullCalendar('refetchEvents');
                            }
                            else{
                                Materialize.toast(stat.data, 4000);
                            }
                        }


                    }
                    xmlHttp.open("POST", theUrl, true); // true for asynchronous
                    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencodeds");
                    xmlHttp.send(json_upload);

                }

            },
            eventResize: function(event, delta, revertFunc) {

                if (!confirm("Are you sure about this change?")) {
                    revertFunc();
                }
                else{

                    var theUrl = "/wfm/change/";
                    var json_upload = JSON.stringify({profile:event.resourceId, event:event.id, start: event.start, end: event.end, title: event.title, time_delta: delta.asMinutes()});

                    var xmlHttp = new XMLHttpRequest();

                    xmlHttp.onreadystatechange = function() {
                        if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                            var stat = JSON.parse(xmlHttp.responseText);
                            if(stat.Status == 'OK'){
                                Materialize.toast(stat.data, 4000);
                            }
                            else{
                                Materialize.toast(stat.data, 4000);
                            }
                        }


                    }
                    xmlHttp.open("POST", theUrl, true); // true for asynchronous
                    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencodeds");
                    xmlHttp.send(json_upload);

                }

            },
            eventMouseover: function(event, jsEvent, view){
                var msg = "<strong>" + event.title + "</strong><br/>From: " + event.start.format("h:mm A") + "<br/>To: " + event.end.format("h:mm A");
                var tooltip = '<div class="tooltipevent" style="width:150px;height:60px;background:#fff;position:absolute;z-index:10001;">' + msg + '</div>';
                var $tooltip = $(tooltip).appendTo('body');

                $(this).mouseover(function(e) {
                    $(this).css('z-index', 10000);
                    $tooltip.fadeIn('500');
                    $tooltip.fadeTo('10', 1.9);
                }).mousemove(function(e) {
                    $tooltip.css('top', e.pageY + 10);
                    $tooltip.css('left', e.pageX + 20);
                });
            },
            eventMouseout: function(calEvent, jsEvent) {
                $(this).css('z-index', 8);
                $('.tooltipevent').remove();
            },
             dayClick: function(date, jsEvent, view, resourceObj) {

                console.log('Clicked on: ' + date.format());

                console.log('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);

                console.log('Current view: ' + view.name);
                 
                console.log('Resource ID: ' + resourceObj.id);
                 console.log(resourceObj);
                 
                 
                var theUrl = "/wfm/change/";
                var json_upload = JSON.stringify({profile: resourceObj.id, event:event.id, start: event.start, end: event.end, title: event.title, time_delta: delta.asMinutes()});

                var xmlHttp = new XMLHttpRequest();

                xmlHttp.onreadystatechange = function() {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                        var stat = JSON.parse(xmlHttp.responseText);
                        if(stat.Status == 'OK'){
                            Materialize.toast(stat.data, 4000);
                        }
                        else{
                            Materialize.toast(stat.data, 4000);
                        }
                    }


                }
                xmlHttp.open("POST", theUrl, true); // true for asynchronous
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencodeds");
                xmlHttp.send(json_upload);

              }
		});
		$('.tooltipped').tooltip({delay: 50});
	});

    </script>
{% endblock head_js %}
{% block pagetitle %}WFM Calendar{% endblock pagetitle %}
{% block content %}
    <div id='header'>
        <span>{{ name }}</span>

    </div>
	<div id='calendar'></div>
    <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Modal Header</h4>
      <p>A bunch of text</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
  </div>
{% endblock content %}
