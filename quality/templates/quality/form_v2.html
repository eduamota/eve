{% extends 'site/base.html' %}

{% block title %}Quality{% endblock %}
   
    {% block head_css_section %}
    {% endblock head_css_section %}

    {% block head_css_page %}
        <style>
             .error {color: #FF0000;}
             
             .pinned {width: 70%; padding-left: 80px}
        </style>
    {% endblock head_css_page %}
{% block pagetitle %}Quality Call Assurance Form{% endblock pagetitle %}
{% block content %}
    {% if errors %}
        
        {% for field, value in errors.items %}
            <script>Materialize.toast('{{value}}', 4000, 'red');</script>
        {% endfor %}
        
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <script>Materialize.toast('{{message}}', 4000, 'green');</script>
        {% endfor %}
    {% endif %}

    <div class="container" id="form-quality">
        
        <form method="post" action="">
            {% csrf_token %}
            <div class="block">
  
            <div class="grey lighten-2">
            <div class="row">
                
                <div class="input-field col s3">
                    <select id="selectEvalName" name="selectEvalName">
                        {% for id, name in supervisor.items %}
                            <option value="{{id}}" selected>{{name}}</option>
                        {% endfor %}
                    </select>
                    <label>Who is evaluating?</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="selectAgentName" name="selectAgentName">
                        <option value="" disabled selected>Choose an agent</option>
                        {% for key, agent in agents.items %}
                            <option value="{{key}}">{{agent}}</option>
                        {% endfor %}
                    </select>
                    <label>Agent Name</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="selectLanguage" name="selectlanguage">
                        <option value="" disabled selected>Choose a language</option>
                        {% for key, language in languages.items %}
                            <option value="{{key}}">{{language}}</option>
                        {% endfor %}
                    </select>
                    <label>Call Language</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="inputWalletNumber" name="inputWalletNumber" type="text" class="validate">
                    <label for="inputWalletNumber">Account Number</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s3">
                    <input id="calendarDateCall" name="CalendarDateCall" type="text" class="datepicker">
                    <label for="calendarDateCall">Date of Call</label>
                </div>
                <div class="input-field col s3">
                    <input id="inputProgramName" name="inputProgramName" type="text" class="validate">
                    <label for="inputProgramName">Program Name</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="inputRecordingFile" name="inputRecordingFile" type="text" class="validate">
                    <label for="inputRecordingFile">Recording File Name</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="selectEvalType" name="selectEvalType">
                        <option value="" disabled selected>Choose a Bank</option>
                        <option value="Metabank">Metabank</option>
                        <option value="Metabank">All Trans</option>
                        <option value="Metabank">Bancorp</option>
                        <option value="Metabank">Valitor</option>
                        <option value="Internal">HW Internal</option>
                    </select>
                    <label>Related to Bank</label>
                </div>
            
            </div>
                
                <div class="row">
                <div class="input-field col s3">
                    <input id="calendarDateEval" name="calendarDateEval" type="text" class="datepicker">
                    <label for="calendarDateEval">Date of Evaluation</label>
                </div>
                <div class="input-field col s3">
                    <input id="inputLengthCall" name="inputLengthCall" type="text" class="validate">
                    <label for="inputLengthCall">Length of Call [min:sec]</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="inputPrimaryReason" name="inputPrimaryReason" type="text" class="validate">
                    <label for="inputPrimaryReason">Primary Reason for Contact</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="inputSecondaryReason" name="inputSecondaryReason" type="text" class="validate">
                    <label for="inputSecondaryReason">Secondary Reason for Contact</label>
                </div>
            
            </div>
                
            </div>

            </div>
            <div class="row">
                <h4 class="col s2">Total Score</h4>
                <h4 class="col s2" id="OverallTotal">0.00%</h4>
                <div class="input-field col s3 hide">
                    <input id="TotalScore" name="TotalScore" type="text" class="validate">
                </div>
                <div class="input-field col s3 hide">
                    <input id="form" name="form" type="text" class="validate">
                </div>
                <a class="waves-effect waves-light btn col offset-s2 red modal-trigger" href="#evalModal">Evaluation legend</a>
                <a class="waves-effect waves-light btn col offset-s1 green" href="/quality/form/search">Search Evaluations</a>

            </div>
                
            {% for section in form %}
                {% if section.weight == 0 %}
                    <div id="{{ section.name }}">
                        <div class="row">
                            <div class="col s1">
                                <a class="btn-floating btn-large waves-effect waves-light blue" id="close{{ section.id }}"><i class="material-icons">add</i></a>    
                            </div>
                            <h4 class="col s8">{{ section.name }}</h4>
                            <h4 class="col s3 hide" id="total{{ section.id }}">0 out of {{ section.weight }}%</h4>
                            <h4 class="col s3 hide" id="toth{{ section.id }}">0</h4>
                            <div id="sectionQuestions{{ section.id }}" style="display: none;">
                            
                                <div class="row">
                            {% for q in section.questions %}
                                
                                    <div class="input-field col s4">
                                      <textarea id="{{ q.id }}" name="{{ q.id }}" class="materialize-textarea"></textarea>
                                      <label for="{{ q.id }}">{{ q.question }}</label>
                                    </div>
                                
                            {% endfor %}
                                    </div>
                            </div>
                        </div>
                    </div>
            
                {% else %}
            
                    <div id="{{ section.name }}">
                        <div class="row">
                            <div class="col s1">
                                <a class="btn-floating btn-large waves-effect waves-light blue" id="close{{ section.id }}"><i class="material-icons">add</i></a>
                            </div>
                            <h4 class="col s8">{{ section.name }} - {{ section.weight }}% of Total</h4>
                            <h4 class="col s3" id="total{{ section.id }}">0 out of {{ section.weight }}%</h4>
                            <h4 class="col s3 hide" id="toth{{ section.id }}">0</h4>
                            <div id="sectionQuestions{{ section.id }}" style="display: none;">

                                {% for q in section.questions %}
                                <div class="row">
                                    <h5 id="{{ q.id }}L" name="{{ q.id }}L" class="col s6 offset-s1">{{ q.question }}</h5>
                                    <select id="{{ q.id }}" name="{{ q.id }}" class="col s2"  v-model="question{{q.id}}">
                                        <option value="0" disabled selected>Select a score</option>
                                        {% for answer in q.answers %}
                                        <option value="{{ answer.weight }}">{{ answer.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label>Score</label>

                                </div>
                                {% endfor %} 

                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            
            <div class="fixed-action-btn" style="bottom: 135px; right: 24px;">
                <a id="menu" class="waves-effect waves-light btn btn-floating red" onclick="$('.tap-target').tapTarget('open')"><i class="material-icons">menu</i></a>
            </div>
            
            <div class="tap-target red" data-activates="menu">
                <div class="tap-target-content white-text">
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <h5>Evaluation Legend</h5>
                    <p>4 Exceptional  - Exceptionally meets full requirements
                    <br /><br />3 Exceptional  - Meets requirements
                    <br /><br />2 Exceptional  - Partially meets the requirement. <br /> &nbsp;&nbsp;&nbsp;&nbsp; Needs improvement
                    <br /><br />1 Exceptional  - Fails to meet requirement. <br /> &nbsp;&nbsp;&nbsp;&nbsp; Needs improvement
                    <br /><br />Not Applicable (N/A)  - Does not apply to the item selection or not observed</p>
                </div>
            </div>
            
            <!-- Modal Structure -->
            <div id="evalModal" class="modal">
                <div class="modal-content">
                    <h4>Evaluation Guide</h4>
                    {% load static %}
                    <img class="materialboxed center" width="950" src="{% static '\evalLegend.png' %}">
                </div>
                <div class="modal-footer">
                    <a href="" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
                </div>
          </div>
            
            <br/>
            <br/>
            <br/>
            
            <div class="row">
                <div class="col s4">
                    <h6>Acknowledgement by CSR</h6>
                </div>
                <div class="col s4 offset-s4">
                    <h6>Acknowledgement by Assessor</h6>
                </div>
            </div>
            
            <div class="row">
                <div class="col s4 input-field">
                    <input id="inputAcknAgent" type="text" class="validate">
                    <label for="inputAcknAgent">Name</label>
                </div>
                <div class="col s4 offset-s4 input-field">
                    <input id="inputAcknAssessor" type="text" class="validate">
                    <label for="inputAcknAssessor">Name</label>
                </div>
            </div>
            
            
            <div class="row">
                <div class="col s4 input-field">
                    <input id="inputAcknAgentDate" type="text" class="validate">
                    <label for="inputAcknAgentDate">Date</label>
                </div>
                <div class="col s4 offset-s4 input-field">
                    <input id="inputAcknAssessorDate" type="text" class="validate">
                    <label for="inputAcknAssessorDate">Date</label>
                </div>
            </div>
            
            <div class="row">
                <div class="col s4 input-field">
                    <input id="inputAcknAgentSignature" type="text" class="validate">
                    <label for="inputAcknAgentSignature">Signature</label>
                </div>
                <div class="col s4 offset-s4 input-field">
                    <input id="inputAcknAssessor" type="text" class="validate">
                    <label for="inputAcknAssessor">Signature</label>
                </div>
            </div>
            
            <div class="row">
                <div class="col s2 input-field">
                    <button class="btn waves-effect waves-light" type="submit" name="action" value="submit">Submit<i class="material-icons right">send</i></button>
                </div>
                
                <div class="col s2 input-field">
                    <button class="btn waves-effect waves-light" type="reset" name="clear" value="clear">Clear</button>
                </div>
                
            </div>
            
            <br/>
            <br/>
            
        </form>
    
    </div>
    
    <script>
        
        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#form-quality',
            data: {
                {% for section in form %} {% for question in section.questions %} question{{ question.id}}: 0, {% endfor %}{% endfor %}
            },
            computed: {
                // a computed getter
                {% for section in form %} section{{ section.id }}() { qTotal = {% for question in section.questions %} parseFloat(this.question{{ question.id}}) + {% endfor %} 0; return qTotal;
                }, {% endfor %} 
              },
            ready: function() {
              $("select").material_select();
            }
            
        });
        
        $(document).ready(function() {
            $('.materialboxed').materialbox();
            $('.blockPinned').pushpin({
              top: 100,
              offset: 70,
            });
            
            $("select").material_select(); 
            
            $('#dateCall').pickadate({
                selectMonths: true, // Creates a dropdown to control month
                selectYears: 15, // Creates a dropdown of 15 years to control year,
                today: 'Today',
                clear: 'Clear',
                close: 'Ok',
                closeOnSelect: false, // Close upon selecting a date,
                format: 'yyyy-mm-dd', 
                formatSubmit: 'yyyy-mm-dd',
              });
            
            $('.modal').modal();
            
            {% for section in form %}
            
            $("#close{{ section.id }}").click(function(){
                $("#sectionQuestions{{ section.id }}").toggle();
            });
            {% endfor %}
            
        {% if fields %}
            {% for field, value in fields.items %}
                $('#{{field}}').val('{{value}}');
            {% endfor %}
            
            {%for field, value in dropdowns.items %}
                $('#{{field}}').val('{{value}}').trigger('change');
                $('#{{field}}').material_select(); 
            {% endfor %}
        
        {% endif %}
        
            $('#dateCall').pickadate({ dateFormat: 'yyyy-mm-dd',  formatSubmit: 'yyyy-mm-dd',});
            
            {% for section in form %} 
                {% for question in section.questions %} 
                $("#{{question.id}}").change(function(){
                    evalSection({{section.id}}, {{section.weight}}, {{section.questions|length}});
                });
                {% endfor %}
            {% endfor %}
            
            function evalSection(fNum, perc, questions){
            var numFields = 0;
            var total = 0;
            selectObjects = $('#sectionQuestions' + fNum + ' select');
                
            selectObjects.each(function(index){
                value = $(this).val()
                if(value != "NA" && value != null){
                    total += parseFloat(value);
                }
            });
            
            $("#total"+fNum).text(total + "% out of " + perc + "%");
            $("#toth"+fNum).text(total);
            
            evalTotal();
        }
        
        function evalTotal(){
            var total = 0;
            $('[id^="toth"]').each(function(index){
                total += parseFloat($(this).text());
            });

            $("#OverallTotal").text(total + "%");
            $("#TotalScore").val(total);
        }
            
            });
    </script>
{% endblock content %}
    
