{% extends 'site/base.html' %}

{% block title %}Quality{% endblock %}
   
    {% block head_css_section %}
    {% endblock head_css_section %}

    {% block head_css_page %}
        <style>
             .error {color: #FF0000;}
             
             .pinned {width: 70%; padding-left: 80px}
        </style>
    {% endblock head_css_page %}
{% block pagetitle %}Quality Call Assurance Form{% endblock pagetitle %}
{% block content %}
    {% if errors %}
        
        {% for field, value in errors.items %}
            <script>Materialize.toast('{{value}}', 4000, 'red');</script>
        {% endfor %}
        
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <script>Materialize.toast('{{message}}', 4000, 'green');</script>
        {% endfor %}
    {% endif %}

    <div class="container" id="form-quality">
        
        <form method="post" action="">
            {% csrf_token %}
            <div class="blockPinned">
  
            <div class="grey lighten-2">
            <div class="row">
                
                <div class="input-field col s3">
                    <select id="evalName" name="evalName">
                        {% for id, name in supervisor.items %}
                            <option value="{{id}}" selected>{{name}}</option>
                        {% endfor %}
                    </select>
                    <label>Who is evaluating?</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="agentName" name="agentName">
                        <option value="" disabled selected>Choose an agent</option>
                        {% for key, agent in agents.items %}
                            <option value="{{key}}">{{agent}}</option>
                        {% endfor %}
                    </select>
                    <label>Agent Name</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="language" name="language">
                        <option value="" disabled selected>Choose a language</option>
                        {% for key, language in languages.items %}
                            <option value="{{key}}">{{language}}</option>
                        {% endfor %}
                    </select>
                    <label>Call Language</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="walletNumber" name="walletNumber" type="text" class="validate">
                    <label for="walletNumber">Wallet / ID Number</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s3">
                    <input id="dateCall" name="dateCall" type="text" class="datepicker">
                    <label for="dateCall">Date of Call</label>
                </div>
                <div class="input-field col s3">
                    <input id="typeCall" name="typeCall" type="text" class="validate">
                    <label for="typeCall">Program Name</label>
                </div>
                
                <div class="input-field col s3">
                    <input id="recordingFile" name="recordingFile" type="text" class="validate">
                    <label for="recordingFile">Call ID</label>
                </div>
                
                <div class="input-field col s3">
                    <select id="evalType" name="evalType">
                        <option value="" disabled selected>Evaluation Type</option>
                        <option value="Metabank">Metabank</option>
                        <option value="Internal">HW Internal</option>
                    </select>
                    <label>Evaluation Type</label>
                </div>
            
            </div>
            </div>

            </div>
            <div class="row">
                <h4 class="col s2">Total Score</h4>
                <h4 class="col s2" id="OverallTotal">0.00%</h4>
                <div class="input-field col s3 hide">
                    <input id="TotalScore" name="TotalScore" type="text" class="validate">
                </div>
                <div class="input-field col s3 hide">
                    <input id="form" name="form" type="text" class="validate">
                </div>
                <a class="waves-effect waves-light btn col offset-s2 red" onclick="$('.tap-target').tapTarget('open')">Evaluation legend</a>
                <a class="waves-effect waves-light btn col offset-s1 green" href="/quality/form/search">Search Evaluations</a>

            </div>
                
            {% for section in form %}
            <div id="{{ section.name }}">
                <div class="row">
                    <div class="col s1">
                        <a class="btn-floating btn-large waves-effect waves-light blue" id="close{{ section.id }}"><i class="material-icons">add</i></a>
                    </div>
                    <h4 class="col s8">{{ section.name }} - {{ section.weight }}% of Total</h4>
                    <h4 class="col s3" id="total{{ section.id }}">0 out of {{ section.weight }}%</h4>
                    <h4 class="col s3 hide" id="toth{{ section.id }}">0</h4>
                    <div id="sectionQuestions{{ section.id }}" style="display: none;">
                        
                        {% for q in section.questions %}
                        <div class="row">
                            <h5 id="{{ q.id }}L" name="{{ q.id }}L" class="col s6 offset-s1">{{ q.question }}</h5>
                            <select id="{{ q.id }}" name="{{ q.id }}" class="col s2"  v-model="question{{q.id}}">
                                <option value="0" disabled selected>Select a score</option>
                                {% for answer in q.answers %}
                                <option value="{{ answer.weight }}">{{ answer.name }}</option>
                                {% endfor %}
                            </select>
                            <label>Score</label>
                            
                        </div>
                        {% endfor %} 
                        
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="OverallComments" name="OverallComments" class="materialize-textarea"></textarea>
                    <label for="OverallComments">Overall Comments</label>
                </div>
            </div>
            
            <div class="fixed-action-btn" style="bottom: 135px; right: 24px;">
                <a id="menu" class="waves-effect waves-light btn btn-floating red" onclick="$('.tap-target').tapTarget('open')"><i class="material-icons">menu</i></a>
            </div>
            
            <div class="tap-target red" data-activates="menu">
                <div class="tap-target-content white-text">
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <p>.</p>
                    <h5>Evaluation Legend</h5>
                    <p>4 Exceptional  - Exceptionally meets full requirements
                    <br /><br />3 Exceptional  - Meets requirements
                    <br /><br />2 Exceptional  - Partially meets the requirement. <br /> &nbsp;&nbsp;&nbsp;&nbsp; Needs improvement
                    <br /><br />1 Exceptional  - Fails to meet requirement. <br /> &nbsp;&nbsp;&nbsp;&nbsp; Needs improvement
                    <br /><br />Not Applicable (N/A)  - Does not apply to the item selection or not observed</p>
                </div>
            </div>
            
            <!-- Modal Structure -->
            <div id="searchresults" class="modal bottom-sheet">
                <div class="modal-content">
                    <h4>Previous Evaluations</h4>
                    <ul class="collection">
                    </ul>
                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
                </div>
          </div>
            <div class="row">
                <div class="col s2">
                    <button class="btn waves-effect waves-light" type="submit" name="action" value="submit">Submit<i class="material-icons right">send</i></button>
                </div>
                
                <div class="col s2">
                    <button class="btn waves-effect waves-light" type="reset" name="clear" value="clear">Clear</button>
                </div>
                
            </div>
            
            <br/>
            <br/>
        </form>
    
    </div>
    
    <script>
        
        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#form-quality',
            data: {
                {% for section in form %} {% for question in section.questions %} question{{ question.id}}: 0, {% endfor %}{% endfor %}
            },
            computed: {
                // a computed getter
                {% for section in form %} section{{ section.id }}() { qTotal = {% for question in section.questions %} parseFloat(this.question{{ question.id}}) + {% endfor %} 0; return qTotal;
                }, {% endfor %} 
              },
            ready: function() {
              $("select").material_select();
            }
            
        });
        
        $(document).ready(function() {
            
            $('.blockPinned').pushpin({
              top: 100,
              offset: 70,
            });
            
            $("select").material_select(); 
            
            $('#dateCall').pickadate({
                selectMonths: true, // Creates a dropdown to control month
                selectYears: 15, // Creates a dropdown of 15 years to control year,
                today: 'Today',
                clear: 'Clear',
                close: 'Ok',
                closeOnSelect: false, // Close upon selecting a date,
                format: 'yyyy-mm-dd', 
                formatSubmit: 'yyyy-mm-dd',
              });
            
            $('.modal').modal();
            
            {% for section in form %}
            
            $("#close{{ section.id }}").click(function(){
                $("#sectionQuestions{{ section.id }}").toggle();
            });
            {% endfor %}
            
        {% if fields %}
            {% for field, value in fields.items %}
                $('#{{field}}').val('{{value}}');
            {% endfor %}
            
            {%for field, value in dropdowns.items %}
                $('#{{field}}').val('{{value}}').trigger('change');
                $('#{{field}}').material_select(); 
            {% endfor %}
        
        {% endif %}
        
            $('#dateCall').pickadate({ dateFormat: 'yyyy-mm-dd',  formatSubmit: 'yyyy-mm-dd',});
            
            {% for section in form %} 
                {% for question in section.questions %} 
                $("#{{question.id}}").change(function(){
                    evalSection({{section.id}}, {{section.weight}}, {{section.questions|length}});
                });
                {% endfor %}
            {% endfor %}
            
            function evalSection(fNum, perc, questions){
            var numFields = 0;
            var total = 0;
            selectObjects = $('#sectionQuestions' + fNum + ' select');
                
            selectObjects.each(function(index){
                value = $(this).val()
                if(value != "NA" && value != null){
                    total += parseFloat(value);
                }
            });
            
            $("#total"+fNum).text(total + "% out of " + perc + "%");
            $("#toth"+fNum).text(total);
            
            evalTotal();
        }
        
        function evalTotal(){
            var total = 0;
            $('[id^="toth"]').each(function(index){
                total += parseFloat($(this).text());
            });

            $("#OverallTotal").text(total + "%");
            $("#TotalScore").val(total);
        }
            
            });
    </script>
{% endblock content %}
    
